<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Manager Pro</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <style>
        :root { --primary: #0969da; --danger: #cf222e; --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* UTILS */
        .hidden { display: none !important; }
        .container { width: 100%; max-width: 800px; padding: 20px; box-sizing: border-box; }
        
        /* BUTTONS & INPUTS */
        .btn { cursor: pointer; padding: 10px 16px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; border: none; }
        .btn-danger { background-color: var(--danger); color: white; border: none; }
        .btn-secondary { background-color: #21262d; color: var(--text); border: 1px solid var(--border); }
        .btn:hover { opacity: 0.85; }
        
        input { background: #0d1117; border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        input:focus { border-color: var(--primary); outline: none; }
        
        /* Disabled Input Style (The "Locked" Look) */
        input:disabled { opacity: 0.5; cursor: not-allowed; background-color: #25282e; border-color: #444; }

        /* LOGIN SCREEN */
        #login-screen { text-align: center; margin-top: 80px; }
        .token-guide { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 6px; text-align: left; margin-bottom: 20px; font-size: 0.95em; line-height: 1.6; }

        /* DASHBOARD */
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; width: 100%; }
        
        /* EDITOR */
        .editor-panel { background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px; }
        .editor-title { margin-top: 0; font-size: 1.1em; color: #fff; margin-bottom: 15px; }
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* LIST */
        .link-item { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 15px; }
        .link-info { flex: 1; min-width: 200px; }
        .link-id { font-weight: bold; color: #58a6ff; font-size: 1.2em; display: block; margin-bottom: 4px; }
        .link-url { color: #8b949e; font-size: 0.9em; word-break: break-all; }
        .actions { display: flex; gap: 8px; }

        /* MODALS */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(13, 17, 23, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(5px); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #qr-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; text-align: center; color: black; max-width: 320px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p id="loader-text" style="margin-top: 20px; font-weight: bold;">Loading...</p>
    </div>

    <div id="login-screen" class="container hidden">
        <h1>üîê Admin Login</h1>
        <div class="token-guide">
            <strong>One-time Setup:</strong>
            <ol>
                <li>Log in to GitHub.com</li>
                <li>Go to <strong>Settings</strong> > <strong>Developer settings</strong> > <strong>Personal access tokens (Classic)</strong>.</li>
                <li>Generate new token. Select <code>gist</code> scope.</li>
                <li>Paste the key (starts with <code>ghp_...</code>) below.</li>
            </ol>
        </div>
        <input type="password" id="api-token" placeholder="ghp_xxxxxxxxxxxx" />
        <button class="btn btn-primary" style="width:100%; padding: 15px;" onclick="handleLogin()">Login Dashboard</button>
    </div>

    <div id="dashboard" class="container hidden">
        <header>
            <div style="font-weight:bold; font-size:1.4em;">QR Link Manager</div>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </header>

        <div class="editor-panel">
            <h3 class="editor-title" id="editor-heading">Add New Link</h3>
            <div class="input-group">
                <input id="inp-id" type="text" placeholder="Short ID (e.g. promo)" style="flex:1;">
                <input id="inp-url" type="url" placeholder="Destination URL (https://...)" style="flex:2;">
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button id="btn-save" class="btn btn-primary" style="flex:1" onclick="saveLink()">Add Link</button>
                <button id="btn-cancel" class="btn btn-secondary hidden" onclick="cancelEdit()">Cancel Edit</button>
            </div>
        </div>

        <h3 style="color: #8b949e; font-size: 0.9em; text-transform: uppercase;">Active Links</h3>
        <div id="link-list"></div>
    </div>

    <div id="qr-modal" class="hidden">
        <div class="modal-content">
            <h3 style="margin-top:0">Scan Me</h3>
            <div id="qr-canvas"></div>
            <p id="qr-target-id" style="font-weight:bold; color: var(--primary); margin: 10px 0;"></p>
            <button class="btn btn-primary" style="width:100%;" onclick="downloadQR()">Download PNG</button>
            <button class="btn btn-danger" style="width:100%; margin-top:12px;" onclick="closeModal()">Close Window</button>
        </div>
    </div>

    <script>
        // ================= STATE =================
        const GIST_FILENAME = "qr_database.json";
        const GIST_DESC = "Database for QR App";
        let GITHUB_TOKEN = localStorage.getItem("gh_token");
        let GIST_ID = localStorage.getItem("gh_gist_id");
        let DB_DATA = {}; 

        const appUrl = window.location.href.split('?')[0];
        const qrCode = new QRCodeStyling({ width: 220, height: 220, type: "svg", dotsOptions: { color: "#000000", type: "square" }});

        // ================= INIT =================
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            
            if (params.get('id') && params.get('u') && params.get('g')) {
                performRedirect(params.get('u'), params.get('g'), params.get('id'));
            } else {
                if (GITHUB_TOKEN) initDashboard();
                else show("login-screen");
            }
        };

        // ================= ADMIN LOGIC =================

        async function handleLogin() {
            const token = document.getElementById("api-token").value.trim();
            if (token.length < 10) return alert("Please enter a valid token");
            
            GITHUB_TOKEN = token;
            localStorage.setItem("gh_token", token);
            initDashboard();
        }

        async function initDashboard() {
            show("loader");
            try {
                const userReq = await fetch("https://api.github.com/user", { headers: { Authorization: `token ${GITHUB_TOKEN}` }});
                if(!userReq.ok) throw new Error("Token invalid");
                const userData = await userReq.json();
                localStorage.setItem("gh_username", userData.login);

                if (!GIST_ID) await findOrCreateGist();

                await refreshData();
                show("dashboard");
            } catch (err) {
                alert("Login Error: " + err.message);
                logout();
            } finally {
                hide("loader");
            }
        }

        async function refreshData() {
            const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, { 
                headers: { Authorization: `token ${GITHUB_TOKEN}` },
                cache: "no-store" 
            });
            const data = await res.json();
            const content = data.files[GIST_FILENAME].content;
            DB_DATA = JSON.parse(content || "{}");
            renderList();
        }

        async function findOrCreateGist() {
            const res = await fetch("https://api.github.com/gists", { headers: { Authorization: `token ${GITHUB_TOKEN}` }});
            const gists = await res.json();
            const existing = gists.find(g => g.files[GIST_FILENAME]);
            
            if (existing) {
                GIST_ID = existing.id;
            } else {
                const create = await fetch("https://api.github.com/gists", {
                    method: "POST",
                    headers: { Authorization: `token ${GITHUB_TOKEN}` },
                    body: JSON.stringify({ description: GIST_DESC, public: true, files: { [GIST_FILENAME]: { content: "{}" } } })
                });
                const created = await create.json();
                GIST_ID = created.id;
            }
            localStorage.setItem("gh_gist_id", GIST_ID);
        }

        async function syncToGitHub() {
            show("loader");
            try {
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: "PATCH",
                    headers: { Authorization: `token ${GITHUB_TOKEN}` },
                    body: JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(DB_DATA, null, 2) } } })
                });
                await refreshData();
            } catch(e) {
                alert("Sync failed: " + e.message);
            } finally {
                hide("loader");
            }
        }

        // ================= UI ACTIONS =================

        function renderList() {
            const list = document.getElementById("link-list");
            list.innerHTML = "";
            const ids = Object.keys(DB_DATA).reverse(); 

            if(ids.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:20px; color:#555;'>No links yet. Create one above.</div>";
                return;
            }

            ids.forEach(id => {
                const url = DB_DATA[id];
                const item = document.createElement("div");
                item.className = "link-item";
                item.innerHTML = `
                    <div class="link-info">
                        <span class="link-id">${id}</span>
                        <span class="link-url">${url}</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="startEdit('${id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-secondary" onclick="showQR('${id}')">üì± QR</button>
                        <button class="btn btn-danger" onclick="deleteLink('${id}')">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function saveLink() {
            const id = document.getElementById("inp-id").value.trim();
            let url = document.getElementById("inp-url").value.trim();

            if (!id || !url) return alert("Fill in both ID and URL");
            if (!url.startsWith("http")) url = "https://" + url;

            // Save new/updated entry (ID never changes if we are editing because input is locked)
            DB_DATA[id] = url; 
            
            cancelEdit();
            syncToGitHub();
        }

        function startEdit(id) {
            window.scrollTo(0,0);
            
            // Populate Fields
            document.getElementById("inp-id").value = id;
            document.getElementById("inp-id").disabled = true; // <--- LOCK THE ID INPUT
            document.getElementById("inp-url").value = DB_DATA[id];
            
            // UI Feedback
            document.getElementById("editor-heading").innerText = "Edit Link: " + id;
            document.getElementById("btn-save").innerText = "Update Link";
            document.getElementById("btn-save").classList.remove("btn-primary");
            document.getElementById("btn-save").style.backgroundColor = "#238636"; 
            document.getElementById("btn-cancel").classList.remove("hidden");
        }

        function cancelEdit() {
            document.getElementById("inp-id").value = "";
            document.getElementById("inp-id").disabled = false; // <--- UNLOCK ID FOR NEW ENTRIES
            document.getElementById("inp-url").value = "";
            
            document.getElementById("editor-heading").innerText = "Add New Link";
            document.getElementById("btn-save").innerText = "Add Link";
            document.getElementById("btn-save").classList.add("btn-primary");
            document.getElementById("btn-save").style.backgroundColor = ""; 
            document.getElementById("btn-cancel").classList.add("hidden");
        }

        async function deleteLink(id) {
            if(confirm(`Are you sure you want to delete "${id}"? This will break any printed QR codes.`)) {
                delete DB_DATA[id];
                syncToGitHub();
            }
        }

        // ================= QR & REDIRECT =================

        function showQR(id) {
            const user = localStorage.getItem("gh_username");
            const finalLink = `${appUrl}?u=${user}&g=${GIST_ID}&id=${id}`;
            
            document.getElementById("qr-canvas").innerHTML = "";
            qrCode.update({ data: finalLink });
            qrCode.append(document.getElementById("qr-canvas"));
            document.getElementById("qr-target-id").innerText = id;
            
            show("qr-modal");
        }

        async function performRedirect(user, gistId, linkId) {
            show("loader");
            document.getElementById("loader-text").innerText = "Opening Link...";

            const t = new Date().getTime();
            const rawUrl = `https://gist.githubusercontent.com/${user}/${gistId}/raw/${GIST_FILENAME}?t=${t}`;

            try {
                const res = await fetch(rawUrl);
                if (!res.ok) throw new Error("Link database not found");
                const data = await res.json();
                
                if (data[linkId]) {
                    window.location.replace(data[linkId]);
                } else {
                    alert(`Link ID "${linkId}" not found.`);
                    hide("loader");
                    show("login-screen");
                }
            } catch (err) {
                alert("Error: " + err.message);
                hide("loader");
            }
        }

        function downloadQR() { qrCode.download({ name: "qr-code", extension: "png" }); }
        
        // ================= UTILS =================
        function logout() { localStorage.clear(); location.reload(); }
        function show(id) { document.getElementById(id).classList.remove("hidden"); }
        function hide(id) { document.getElementById(id).classList.add("hidden"); }
        function closeModal() { hide("qr-modal"); }

    </script>
</body>
</html>
