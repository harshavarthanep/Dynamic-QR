<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Dynamic QR</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <style>
        :root { --accent: #0969da; --bg: #ffffff; --text: #24292f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        /* Layout */
        #container { width: 100%; max-width: 600px; padding: 20px; display: flex; flex-direction: column; }
        
        /* Headings */
        h1 { font-size: 1.5rem; margin-bottom: 10px; color: var(--accent); }
        h2 { font-size: 1.1rem; margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* Inputs */
        label { font-weight: 600; font-size: 0.9rem; margin-top: 15px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #d0d7de; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: 2px solid #0969da33; }
        
        /* Buttons */
        .btn { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 20px; font-size: 1rem; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 10px; }
        
        /* Cards */
        .card { background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; padding: 15px; margin-top: 10px; font-size: 0.9rem; }
        
        /* Loading Overlay */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 99; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Mobile specific adjustments */
        #preview-area { display: flex; flex-direction: column; align-items: center; margin-top: 20px; padding: 20px; border: 1px dashed #ccc; border-radius: 8px; }
        
        .error-msg { color: #cf222e; background: #ffebe9; padding: 10px; border-radius: 6px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3 id="loader-title">Connecting...</h3>
        <p id="loader-desc">Checking for latest links</p>
    </div>

    <div id="container" style="display:none;">
        <h1>Mobile QR Maker</h1>
        <p style="color:#57606a; font-size: 0.9rem;">
            A tool to create QR codes that you can update from your phone.
        </p>

        <div class="card">
            <strong>ðŸš€ How to start (Do this once):</strong>
            <ol style="padding-left: 20px; margin: 10px 0;">
                <li>Go to <strong>gist.github.com</strong> on your phone.</li>
                <li>Create a new Gist.</li>
                <li><strong>Filename:</strong> <code>links.json</code></li>
                <li><strong>Content:</strong> Paste the code below exactly:</li>
            </ol>
            <textarea readonly style="width:100%; height:80px; font-family:monospace; font-size:0.8rem; border:1px solid #ddd; border-radius:4px; padding:5px;">
{
  "promo": "https://google.com",
  "menu": "https://instagram.com"
}</textarea>
            <ol start="5" style="padding-left: 20px; margin: 10px 0;">
                <li>Click <strong>"Create Public Gist"</strong>.</li>
                <li>Copy the browser URL of that new Gist page.</li>
            </ol>
        </div>

        <label>1. Paste your Gist URL here:</label>
        <input type="text" id="gist-url" placeholder="https://gist.github.com/username/..." oninput="verifyGist()">
        <div id="gist-error" class="error-msg"></div>

        <div id="controls" style="opacity: 0.5; pointer-events: none;">
            <label>2. Short ID (e.g. "promo")</label>
            <input type="text" id="entry-id" placeholder="Key name from your JSON" oninput="updateQR()">

            <h2>Design</h2>
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Color</label>
                    <input type="color" id="qr-color" value="#000000" style="height:45px;" oninput="updateQR()">
                </div>
                <div style="flex:1">
                    <label>Background</label>
                    <input type="color" id="bg-color" value="#ffffff" style="height:45px;" oninput="updateQR()">
                </div>
            </div>

            <label>Logo URL (Optional)</label>
            <input type="text" id="logo-url" placeholder="https://..." oninput="updateQR()">
        </div>

        <div id="preview-area">
            <div id="qr-canvas"></div>
            <p style="font-size:0.8rem; color:#666; text-align:center; margin-top:10px;">
                This QR code is dynamic.<br>Edit your Gist JSON to change the destination.
            </p>
        </div>
        
        <button class="btn" onclick="downloadQR()">Download Image</button>
    </div>

    <script>
        // ===================================
        // LOGIC
        // ===================================
        
        const currentHost = window.location.href.split('?')[0];
        let qrCode = new QRCodeStyling({
            width: 250, height: 250, type: "svg",
            dotsOptions: { color: "#000000", type: "rounded" },
            backgroundOptions: { color: "#ffffff" }
        });

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            // "u" = Gist Username, "g" = Gist ID, "id" = JSON Key
            const gistUser = params.get('u');
            const gistId = params.get('g');
            const linkId = params.get('id');

            if (gistUser && gistId && linkId) {
                // MODE: Redirect
                handleRedirect(gistUser, gistId, linkId);
            } else {
                // MODE: Creator
                document.getElementById('container').style.display = 'flex';
                qrCode.append(document.getElementById("qr-canvas"));
                
                // Load saved Gist URL
                const savedGist = localStorage.getItem('savedGistUrl');
                if(savedGist) {
                    document.getElementById('gist-url').value = savedGist;
                    verifyGist();
                }
            }
        };

        // --- Redirect Logic ---
        function handleRedirect(user, gistId, linkId) {
            document.getElementById('loader').style.display = 'flex';
            
            // Construct RAW Gist URL (Points to latest commit)
            const rawUrl = `https://gist.githubusercontent.com/${user}/${gistId}/raw`;

            fetch(rawUrl)
                .then(res => {
                    if (!res.ok) throw new Error("Gist not found");
                    return res.json();
                })
                .then(data => {
                    // Find the link
                    const dest = data[linkId] || data[linkId.trim()];
                    if (dest) {
                        let finalLink = dest;
                        if (!finalLink.startsWith('http')) finalLink = 'https://' + finalLink;
                        
                        document.getElementById('loader-title').innerText = "Found!";
                        window.location.replace(finalLink);
                    } else {
                        throw new Error(`ID "${linkId}" not found in your Gist.`);
                    }
                })
                .catch(err => {
                    document.querySelector('.spinner').style.display = 'none';
                    document.getElementById('loader-title').innerText = "Error";
                    document.getElementById('loader-title').style.color = "red";
                    document.getElementById('loader-desc').innerText = err.message;
                });
        }

        // --- Generator Logic ---
        function verifyGist() {
            const url = document.getElementById('gist-url').value.trim();
            const errorBox = document.getElementById('gist-error');
            const controls = document.getElementById('controls');

            // Parse URL: https://gist.github.com/USERNAME/GIST_ID
            const regex = /gist\.github\.com\/([^\/]+)\/([a-zA-Z0-9]+)/;
            const match = url.match(regex);

            if (match) {
                errorBox.style.display = 'none';
                controls.style.opacity = '1';
                controls.style.pointerEvents = 'auto';
                
                localStorage.setItem('savedGistUrl', url);
                updateQR();
            } else {
                if(url.length > 10) {
                    errorBox.style.display = 'block';
                    errorBox.innerText = "Invalid URL. It should look like: https://gist.github.com/username/abc12345...";
                }
                controls.style.opacity = '0.5';
                controls.style.pointerEvents = 'none';
            }
        }

        function updateQR() {
            const url = document.getElementById('gist-url').value;
            const entryId = document.getElementById('entry-id').value || "promo";
            const color = document.getElementById('qr-color').value;
            const bg = document.getElementById('bg-color').value;
            const logo = document.getElementById('logo-url').value;

            // Extract User and ID again
            const regex = /gist\.github\.com\/([^\/]+)\/([a-zA-Z0-9]+)/;
            const match = url.match(regex);
            
            if(!match) return;

            const user = match[1];
            const gistId = match[2];

            // Build the Smart URL
            const dynamicUrl = `${currentHost}?u=${user}&g=${gistId}&id=${entryId}`;

            qrCode.update({
                data: dynamicUrl,
                image: logo,
                dotsOptions: { color: color, type: "rounded" },
                backgroundOptions: { color: bg }
            });
        }

        function downloadQR() {
            qrCode.download({ name: "mobile-qr", extension: "png" });
        }
    </script>
</body>
</html>
